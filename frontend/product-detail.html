<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Home | Product Detail</title>
    <!-- Load Tailwind CSS -->
    <link href="/css/main.css" rel="stylesheet">
    <!-- Use an elegant, sophisticated font like Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Import global cart logic -->
    <script type="module" src="js/cart.js"></script>
    <script>
        /*
        // Placeholder function for cart count update, will be overwritten by cart.js
        window.updateCartCount = () => {
            const count = (window.getCart ? window.getCart() : []).reduce((sum, item) => sum + item.quantity, 0);
            const cartCountElement = document.getElementById('cart-count');
            if(cartCountElement) {
                cartCountElement.textContent = count;
                cartCountElement.classList.toggle('hidden', count === 0);
            }
        }; */
    </script>
</head>
<body class="pt-20">
    <!-- Message Container for Feedback (Used by cart.js:displayMessage) -->
    <div id="message-container" class="fixed top-4 right-4 z-50 flex flex-col items-end space-y-2 max-w-sm w-full"></div>

    <!-- Header Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-[#0d0d0d] bg-opacity-95 backdrop-blur-sm shadow-lg z-40 border-b border-gray-800">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo/Home Link -->
            <a href="index.html" class="text-2xl font-bold text-gold tracking-wider uppercase">Sovereign Home</a>
            
            <!-- Navigation Links (Hidden on Mobile) -->
            <div class="hidden md:flex items-center space-x-6 text-sm font-medium">
                <a href="index.html" class="hover:text-gold transition duration-200">Shop</a>
                <a href="auth.html" class="hover:text-gold transition duration-200">Account</a>
                
                <!-- Cart Link with Count -->
                <a href="cart.html" class="relative hover:text-gold transition duration-200 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="cart-count" class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-600 text-xs text-white font-bold px-2 py-0.5 rounded-full hidden">0</span>
                </a>
            </div>
            
            <!-- Mobile Menu Button (Hamburger) - Not Implemented for Simplicity -->
            <button class="md:hidden text-gray-500 hover:text-gold" title="Toggle navigation menu">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
  </svg>
</button>

        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div id="loading-state" class="text-center py-20">
        <svg class="animate-spin h-10 w-10 text-gold mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-text" class="mt-4 text-gray-400">Loading product details...</p>
    </div>

    <div id="product-main-container" class="hidden lg:grid lg:grid-cols-2 gap-10">

   <!-- <div id="product-detail" class="hidden lg:grid lg:grid-cols-2 gap-10"> -->
        
        <div id="product-image-section" class="lg:sticky lg:top-24 rounded-lg overflow-hidden shadow-2xl border border-gray-800">
            <img id="product-image" class="w-full h-auto object-cover" 
                 src="https://placehold.co/600x600/1a1a1a/d4af37?text=Product+Image" 
                 alt="Placeholder Image for Product"
                 onerror="this.onerror=null;this.src='https://placehold.co/600x600/1a1a1a/d4af37?text=Image+Not+Available'">
        </div>
        <div id="product-info-section" class="pt-4 lg:pt-0">
            <p id="product-category" class="text-sm uppercase tracking-widest text-gold mb-2"></p>
            <h1 id="product-name" class="text-4xl lg:text-5xl font-extrabold mb-4 text-white"></h1>
            <p id="product-price" class="text-3xl font-bold text-gold mb-6"></p>

            <div class="mb-8 border-t border-b border-gray-800 py-6">
                <p class="text-gray-300 leading-relaxed" id="product-description"></p>
            </div>

            <div id="options-container" class="space-y-6 mb-8">
                </div>

            <div class="flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-6">
                
                <div class="flex items-center space-x-3 w-full sm:w-32 border border-gray-700 rounded-lg p-2 bg-[#1a1a1a]">
                    <button id="decrement-qty" 
                            class="text-xl hover:text-gold transition duration-200" 
                            aria-label="Decrease quantity" 
                            title="Decrease quantity">-</button>
                    
                    <input type="number" 
                            id="qty-display" 
                            value="1" 
                            min="1" 
                            class="w-full text-center bg-transparent border-none focus:ring-0 text-xl font-medium" 
                            aria-label="Product quantity"
                            title="Product quantity"
                            placeholder="1"> 
                    
                    <button id="increment-qty" 
                            class="text-xl hover:text-gold transition duration-200" 
                            aria-label="Increase quantity" 
                            title="Increase quantity">+</button>
                </div>

                <p id="product-description" class="text-text-light/80 mb-6"></p>

                <div id="product-options-container" class="space-y-4 mb-8">
                    </div>
                <div class="flex items-center space-x-4 mb-8">
                    </div>

                <button id="add-to-cart-btn" 
                        class="btn-gold w-full sm:w-auto px-8 py-3 rounded-xl font-semibold uppercase text-sm disabled:opacity-50 disabled:cursor-not-allowed" 
                        disabled>
                    Add to Cart
                </button>
            </div>
            
            <p id="stock-status" class="mt-4 text-sm text-gray-500">In Stock</p>

        </div>
    
    </div>
</main>

    <!-- Footer (Optional) -->
    <footer class="mt-20 border-t border-gray-800 text-center py-6 text-sm text-gray-500">
        <p>&copy; 2024 Sovereign Home. All rights reserved. | <a href="index.html" class="hover:text-gold">Shop</a> | <a href="cart.html" class="hover:text-gold">Cart</a></p>
    </footer>

    <!-- Script Block for Product Detail and Cart API Integration -->
    <script>
        window.BASE_URL = "https://backend-commerce-7ncw.onrender.com";
        const products = [
    // Row 1
    { id: 1, name: "White Bow-Tie Pillow", price: 13.85, description: "A set of two soft white pillows tied in a bow, featuring a subtle decorative pattern. Elegant and classic.", image: "https://placehold.co/600x600/181818/D4AF37?text=Bow-Tie+Pillow", options: { size: ["Small", "Medium"], material: ["Cotton", "Linen"] } },
    { id: 2, name: "Red Monkey Fist Knot", price: 21.54, description: "A large, tightly woven red nautical knot used as a decorative object or paperweight, adding a pop of color.", image: "https://placehold.co/600x600/181818/D4AF37?text=Monkey+Fist", options: { color: ["Red", "Burgundy"] } },
    { id: 3, name: "Set of Round Decorative Pillows", price: 25.38, description: "A set of round, textured pillows in varying colors (gray, yellow, black) for a modern, eclectic look.", image: "https://placehold.co/600x600/181818/D4AF37?text=Round+Pillows", options: { set: ["3-Piece", "5-Piece"] } },
    { id: 4, name: "Yellow Lumbar Pillow (Butterfly)", price: 13.85, description: "A bright yellow lumbar pillow featuring a detailed butterfly design, perfect for back support and vibrant decor.", image: "https://placehold.co/600x600/181818/D4AF37?text=Butterfly+Pillow", options: { size: ["Standard", "Large"], color: ["Yellow", "Gold"] } },
    
    // Row 2
    { id: 5, name: "Sausage and Round Set (Gold)", price: 17.69, description: "A coordinated set of gold-toned decorative pillows (one cylindrical, one round) with textural patterns.", image: "https://placehold.co/600x600/181818/D4AF37?text=Gold+Pillow+Set", options: { size: ["Small", "Medium"] } },
    { id: 6, name: "Orange Square Faith Pillow", price: 10.00, description: "A square orange pillow with bold white text reading 'LIVING IN FAITH EVERYDAY'.", image: "https://placehold.co/600x600/181818/D4AF37?text=Faith+Pillow", options: { color: ["Orange", "Terracotta"] } },
    { id: 7, name: "Succulent Scent Decor Candle", price: 10.00, description: "A scented candle in a ceramic pot, featuring a green succulent plant theme for a natural, fresh look.", image: "https://placehold.co/600x600/181818/D4AF37?text=Succulent+Candle", options: { scent: ["Cactus Flower", "Garden Mint"] } },
    { id: 8, name: "Romantic Rose Vanilla Candle", price: 7.31, description: "A simple, white pillar candle with a sweet and delicate rose and vanilla aroma for a calming atmosphere.", image: "https://placehold.co/600x600/181818/D4AF37?text=Rose+Vanilla+Candle", options: { size: ["Small", "Medium", "Large"] } },
    
    // Row 3
    { id: 9, name: "Purple & Blue Chevron Candle", price: 6.15, description: "A small glass jar candle with vibrant purple and blue chevron layers and a bright floral scent.", image: "https://placehold.co/600x600/181818/D4AF37?text=Chevron+Candle", options: { scent: ["Sweet Berry", "Tropical"] } },
    { id: 10, name: "Citrus & Lime Jar Candle", price: 10.00, description: "A brown jar candle with a strong, zesty citrus and lime fragrance to refresh any kitchen or living area.", image: "https://placehold.co/600x600/181818/D4AF37?text=Citrus+Jar+Candle", options: { scent: ["Lime", "Lemon Verbena"] } },
    { id: 11, name: "Heart-Shaped Gem Candle Set", price: 10.00, description: "A set of small, colorful heart-shaped candles resembling gems, ideal for bath time or small decorative accents.", image: "https://placehold.co/600x600/181818/D4AF37?text=Gem+Candle+Set", options: { set: ["6-Pack", "12-Pack"], color: ["Mixed", "Pastel"] } },
    { id: 12, name: "White & Purple Layered Candle", price: 7.31, description: "A white pillar candle with a bright purple outer layer, offering a strong, clean scent.", image: "https://placehold.co/600x600/181818/D4AF37?text=Purple+Layered", options: { scent: ["Floral Bloom", "Powder"], size: ["Medium", "Large"] } }
];

        let productData = null;
        let selectedOptions = {};

        //const BASE_URL = '';
        //const API_CART_URL = `${BASE_URL}/api/cart/add`;

        // Elements
        const loadingState = document.getElementById('loading-state');
        const productImageSection = document.getElementById('product-image-section');
        const productInfoSection = document.getElementById('product-info-section');
        const qtyDisplay = document.getElementById('qty-display');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const optionsContainer = document.getElementById('options-container');
        const mainContainer = document.getElementById('product-main-container');

        // --- Utility & UI Functions ---

        /**
         * IMPORTANT: Retrieves the JWT token. This token must be saved by auth.html.
         * @returns {string} The JWT token.
         */
        const getToken = () => {
             // Look for the token saved during login/register
             return localStorage.getItem('userToken') || 'MOCKED_JWT_TOKEN_FOR_TESTING';
        };

        /**
         * Displays a temporary, stylish message box. (Needs to be exposed globally for other pages)
         * @param {string} message - The message content.
         * @param {string} type - 'success', 'error', or 'info'.
         */


        const checkOptionsAndToggleCartButton = () => {
    // 1. Exit early if product data is not loaded (shouldn't happen here, but safe)
    if (!productData) {
        addToCartBtn.disabled = true;
        addToCartBtn.textContent = 'Loading...';
        return;
    }

    // Get the required options keys. Use an empty array if 'options' property is missing or null.
    const requiredOptions = productData.options ? Object.keys(productData.options) : [];
    
    // Check if the quantity is valid (default to 1 if not)
    const quantity = parseInt(qtyDisplay.value, 10) || 1; 

    // CASE A: Product has NO options defined (e.g., requiredOptions.length === 0)
    if (requiredOptions.length === 0) {
        const totalPrice = productData.price * quantity;
        addToCartBtn.textContent = `Add to Cart - ${window.formatCurrency(totalPrice)}`;
        addToCartBtn.disabled = false; // ENABLE THE BUTTON!
        return;
    }

    // CASE B: Product HAS options defined (i.e., requiredOptions.length > 0)
    const allSelected = requiredOptions.every(key => selectedOptions[key]);

    addToCartBtn.disabled = !allSelected;
    
    if (allSelected) {
        const totalPrice = productData.price * quantity;
        addToCartBtn.textContent = `Add to Cart - ${window.formatCurrency(totalPrice)}`;
    } else {
        // This is the message for when options exist but haven't been selected yet
        addToCartBtn.textContent = "Select Options to Add to Cart";
    }
};
        
      
  const addToCartAPI = async () => {
    if (!productData) return;

    // Use robust quantity parsing (default to 1 if not a valid number)
    const quantity = parseInt(qtyDisplay.value, 10) || 1; 

    const payload = {
        productId: productData.id,
        name: productData.name, 
        price: productData.price,
        quantity: quantity,
        image: productData.image,
        // Use window.selectedOptions for consistency
        size: selectedOptions.size || null,
        scent: selectedOptions.scent || null ,
        material: selectedOptions.material || null,
        color: selectedOptions.color || null,
        set: selectedOptions.set || null
    };

    addToCartBtn.disabled = true;
    addToCartBtn.textContent = 'Adding...';

    try {
        // Call the globally exposed function from cart.js
        // This line only proceeds if the API call was successful
        await window.addToCartAPI(payload);

        
        window.location.href = 'cart.html';

    } catch (e) {
        // The global API handler (window.addToCartAPI) should display the error message.
        console.error("Error adding to cart (local handler):", e);
        // The button will be re-enabled in the finally block.
    } finally {
        // This block will run after 'try' (if successful) OR 'catch' (if failed).
        // Since we redirect on success, we only need to reset the button if an error occurs
        // or if the redirect fails for some reason.
        if (window.location.href.indexOf('cart.html') === -1) {
            addToCartBtn.disabled = false;
            checkOptionsAndToggleCartButton(); // Reset button text
        }
    }
};


        // --- Render Functions ---

        /**
         * Renders the options section (Size, Scent, etc.).
         */
        /**
 * Renders the options section (Size, Scent, etc.).
 * This function is robust and dynamic, handling any option type provided.
 */
const renderOptions = (options) => {
    // CRITICAL FIX: Get the options container element
    const optionsContainer = document.getElementById('product-options-container');
    if (!optionsContainer) {
        console.error("Error: Element with ID 'product-options-container' not found.");
        return; // Exit if the container isn't in the HTML
    }
    
    optionsContainer.innerHTML = ''; // Clear previous options

    // Check if options object is valid and has keys
    if (!options || Object.keys(options).length === 0) {
        // If there are no options, do nothing or display a message
        // Optionally, ensure the Add to Cart button is enabled here if no options are required.
        checkOptionsAndToggleCartButton(); 
        return;
    }

    // Loop through each option type (e.g., 'size', 'scent')
    Object.keys(options).forEach(optionKey => {
        const values = options[optionKey];
        
        // Skip rendering if the option array is empty
        if (!values || values.length === 0) return;

        // Capitalize the option key for display ('scent' -> 'Scent')
        const keyTitle = optionKey.charAt(0).toUpperCase() + optionKey.slice(1);
        
        const optionGroup = document.createElement('div');
        optionGroup.className = 'flex flex-col space-y-2 mb-4'; // Added margin-bottom
        optionGroup.innerHTML = `<span class="font-semibold text-lg text-gold">${keyTitle}:</span>`;

        const valuesContainer = document.createElement('div');
        valuesContainer.className = 'flex flex-wrap gap-3';
        
        // Loop through each option value (e.g., 'Vanilla Bean', 'Sandalwood')
        values.forEach(value => {
            const button = document.createElement('button');
            button.textContent = value;
            button.className = `option-button px-4 py-2 rounded-lg text-sm bg-neutral-800 text-white hover:bg-neutral-700 transition-colors duration-200`;
            button.setAttribute('data-key', optionKey);
            button.setAttribute('data-value', value);

            button.addEventListener('click', (e) => {
                // Deselect all buttons for this option group (using the data-key attribute)
                const buttonsInGroup = valuesContainer.querySelectorAll(`[data-key="${optionKey}"]`);
                buttonsInGroup.forEach(btn => {
                    btn.classList.remove('selected', 'bg-gold', 'text-black');
                    btn.classList.add('bg-neutral-800', 'text-white');
                });
                
                // Select the current button
                e.currentTarget.classList.add('selected', 'bg-gold', 'text-black');
                e.currentTarget.classList.remove('bg-neutral-800', 'text-white');
                
                // Update the selected options state
                selectedOptions[optionKey] = value; 
                checkOptionsAndToggleCartButton();
            });
            
            valuesContainer.appendChild(button);
        });

        optionGroup.appendChild(valuesContainer);
        optionsContainer.appendChild(optionGroup);
    });

    // Initial check to disable button if options are required
    checkOptionsAndToggleCartButton(); 
};

        /**
         * Renders the main product details.
         */
        const renderProduct = (product) => {
            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-price').textContent = formatCurrency(product.price);
            document.getElementById('product-description').textContent = product.description;
            //document.getElementById('product-image').src = product.image;
            //document.getElementById('product-image').onerror = (e) => {
              //  e.target.src = `https://placehold.co/600x600/181818/D4AF37?text=Image+Missing`;
            //};


            renderOptions(product.options || {});
            
            // Hide loading state and show content
            loadingState.classList.add('hidden');
            //productImageSection.classList.remove('hidden');
            //productInfoSection.classList.remove('hidden');
            mainContainer.classList.remove('hidden');
        };

     
const fetchAndRenderProduct = async () => {
    // 1. Get Product ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = parseInt(urlParams.get('id'), 10);
    const loadingTextElement = document.getElementById('loading-text');

    const mainContainer = document.getElementById('product-main-container');

    if (!productId) {
        loadingTextElement.textContent = "Error: No product ID specified in the URL.";
        return;
    }
    
    // 2. Construct API URL and Fetch Data
    const productUrl = `${window.BASE_URL}/api/products/${productId}`;

    try {
        const response = await fetch(productUrl);
        //Updates the GLOBAL variable defined at the top
         productData = await response.json(); // Data is stored here

         console.log("Product Data Received:", productData);
        

        if (response.ok && productData.id) {
            
            
            const imageElement = document.getElementById('product-image');

            imageElement.src = `${window.BASE_URL}/images/${productData.image}`;
            
          imageElement.onerror = (e) => {
                e.target.src = `https://placehold.co/600x600/181818/D4AF37?text=Image+Missing`;
            };

            // Render the rest of the product details
            renderProduct(productData);

            // Hide loading text and show content
            loadingTextElement.classList.add('hidden');
            //mainContainer.classList.remove('hidden');


        } else if (response.status === 404) {
            loadingTextElement.textContent = `Error: Product with ID ${productId} not found.`;
        } else {
            loadingTextElement.textContent = `Error loading product details. Status: ${response.status}`;
        }
        
    } catch (error) {
        console.error("Network or parsing error:", error);
        loadingTextElement.textContent = "A network error occurred while trying to load the product.";
    }

    
};

        // --- Event Listeners and Initialization ---

        /**
         * Handles quantity changes.
         * @param {number} delta - +1 or -1.
         */
        const updateQuantity = (delta) => {
            let currentQty = parseInt(qtyDisplay.value);
            let newQty = currentQty + delta;
            if (newQty < 1) newQty = 1;
            
            qtyDisplay.value = newQty;
            
            // Update the cart button total immediately
            checkOptionsAndToggleCartButton();
        };

        // Quantity Buttons
        document.getElementById('increment-qty').addEventListener('click', () => updateQuantity(1));
        document.getElementById('decrement-qty').addEventListener('click', () => updateQuantity(-1));
        
        // Manual Quantity Input
        qtyDisplay.addEventListener('change', () => {
            let currentQty = parseInt(qtyDisplay.value);
            if (currentQty < 1 || isNaN(currentQty)) {
                qtyDisplay.value = 1;
            }
            // Update the cart button total immediately
            checkOptionsAndToggleCartButton();
        });


        // Add to Cart Button (now calls the API)
        addToCartBtn.addEventListener('click', () => {
            if (addToCartBtn.disabled) {
                window.displayMessage("Please select all required options (Size/Scent) before adding to cart.", 'error');
                return;
            }
            
            // Call the new API function
            addToCartAPI();
        });

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', fetchAndRenderProduct);
        document.addEventListener('DOMContentLoaded', window.updateCartCount); // Update cart count in the header
    </script>
</body>
</html>
