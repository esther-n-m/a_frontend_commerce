<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Home | Shopping Cart</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use an elegant, sophisticated font like Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-gold: #D4AF37; /* Standard gold color */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d; /* Very dark background */
            color: #f5f5f5; /* Off-white text */
            min-height: 100vh;
        }
        .text-gold {
            color: var(--color-gold);
        }
        .bg-gold {
            background-color: var(--color-gold);
        }
        .border-gold {
            border-color: var(--color-gold);
        }
        .btn-gold {
            background-color: var(--color-gold);
            color: #0d0d0d;
            transition: all 0.3s;
        }
        .btn-gold:hover {
            background-color: #E0C16E;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }
        /* Custom spinner for loading */
        .loader {
            border: 4px solid #333;
            border-top: 4px solid var(--color-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            max-width: 90vw;
        }
        .message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Message Box Container -->
    <div id="message-container" class="message-box"></div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center py-4 border-b border-neutral-700 mb-8">
            <a href="index.html" class="text-3xl font-bold text-gold tracking-widest">SOVEREIGN</a>
            <a href="index.html" class="text-sm font-medium text-gray-400 hover:text-gold transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Continue Shopping
            </a>
        </header>

        <h1 class="text-4xl font-light mb-10 border-b border-neutral-800 pb-4">Your Shopping Cart</h1>

        <div class="grid lg:grid-cols-3 gap-10">
            <!-- Cart Items List (Left/Main Column) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Loading State -->
                <div id="cart-loading" class="flex flex-col items-center justify-center p-20 hidden">
                    <div class="loader"></div>
                    <p class="mt-4 text-lg text-gray-400">Loading your luxury items...</p>
                </div>

                <!-- Empty Cart State -->
                <div id="cart-empty" class="text-center p-16 border border-dashed border-neutral-700 rounded-xl hidden">
                    <p class="text-xl text-gray-500 font-light">Your cart is currently empty.</p>
                    <a href="index.html" class="mt-6 inline-block text-gold hover:text-white transition font-medium">Start Exploring</a>
                </div>

                <!-- Cart Items Container -->
                <div id="cart-items-container" class="space-y-6">
                    <!-- Cart items will be rendered here -->
                </div>
            </div>

            <!-- Cart Summary (Right Column) -->
            <div class="lg:col-span-1">
                <div class="bg-neutral-900 p-6 rounded-xl shadow-2xl space-y-6 sticky top-8 border border-neutral-800">
                    <h2 class="text-2xl font-semibold border-b border-neutral-700 pb-3">Order Summary</h2>

                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span>Subtotal (<span id="cart-item-count">0</span> items)</span>
                            <span id="cart-subtotal" class="font-medium">$0.00</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Shipping</span>
                            <span id="cart-shipping">$15.00</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Taxes (10%)</span>
                            <span id="cart-taxes">$0.00</span>
                        </div>
                    </div>

                    <div class="flex justify-between pt-4 border-t border-neutral-700 text-xl font-bold">
                        <span>Order Total</span>
                        <span id="cart-total" class="text-gold">$0.00</span>
                    </div>

                    <button id="checkout-btn" class="w-full btn-gold py-3 rounded-lg font-semibold text-lg shadow-lg" disabled>
                        Proceed to Checkout
                    </button>
                    <button id="clear-cart-btn" class="w-full text-sm text-gray-500 hover:text-red-500 transition duration-200 py-2" disabled>
                        Clear Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Dependencies ---
        // Assumes cart.js is loaded and exposes:
        // window.getCartAPI, window.updateCartItemAPI, window.removeFromCartAPI, 
        // window.calculateCartTotal, window.displayMessage, window.updateCartCount

        // --- DOM Elements ---
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalElement = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const clearCartBtn = document.getElementById('clear-cart-btn');

        
        /**
         * @desc Fetches cart data from the API and renders the cart page.
         */
        window.fetchCart = async () => {
            cartItemsContainer.innerHTML = '<p class="text-center py-8 text-gold">Loading cart...</p>';
            window.updateCartCount();
            
            // Check if user is logged in (token exists)
            if (!window.getCartAPI || !localStorage.getItem('userToken')) {
                renderEmptyCart("Please log in to view your shopping cart.");
                return;
            }

            try {
                const cartItems = await window.getCartAPI();
                renderCart(cartItems);
            } catch (error) {
                renderEmptyCart("Error loading cart. Please check your network connection.");
            }
        };

        
        /**
         * @desc Renders the fetched cart items and updates totals.
         * @param {Array} items - Array of cart items from the API.
         */
        const renderCart = (items) => {
            cartItemsContainer.innerHTML = '';
            const total = window.calculateCartTotal(items);
            
            if (items.length === 0) {
                renderEmptyCart("Your cart is currently empty.");
                return;
            }

            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex justify-between items-center py-4 border-b border-neutral-700 last:border-b-0';
                
                // CRITICAL: We need the MongoDB _id for removal/update
                const itemId = item._id; 
                
                itemElement.innerHTML = `
                    <div class="flex items-center space-x-4 flex-grow">
                        <img src="${item.image || 'placeholder.jpg'}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md border border-neutral-700">
                        <div>
                            <p class="font-semibold text-white">${item.name}</p>
                            ${item.size ? `<p class="text-sm text-gray-400">Size: ${item.size}</p>` : ''}
                            ${item.scent ? `<p class="text-sm text-gray-400">Scent: ${item.scent}</p>` : ''}
                            <p class="text-sm text-gold mt-1">Ksh ${item.price.toFixed(2)}</p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-6">
                        <input type="number" 
                            data-id="${itemId}" 
                            value="${item.quantity}" 
                            min="1" 
                            class="qty-input w-16 px-2 py-1 bg-neutral-800 border border-neutral-700 rounded-md text-center text-white focus:ring-gold focus:border-gold"
                        >
                        <button data-id="${itemId}" class="remove-btn text-gray-500 hover:text-red-500 transition duration-150" aria-label="Remove item">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemElement);
            });

            // Update totals and button states
            cartTotalElement.textContent = `Ksh ${total.toFixed(2)}`;
            checkoutBtn.disabled = false;
            clearCartBtn.disabled = false;
            
            attachCartEventListeners();
        };

        /**
         * @desc Displays a message when the cart is empty.
         */
        const renderEmptyCart = (message) => {
            cartItemsContainer.innerHTML = `<p class="text-center py-8 text-gray-400">${message}</p>`;
            cartTotalElement.textContent = 'Ksh 0.00';
            checkoutBtn.disabled = true;
            clearCartBtn.disabled = true;
        }

        
        /**
         * @desc Attaches event listeners for removing and updating item quantities.
         */
        const attachCartEventListeners = () => {
            // Remove button listener
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = e.currentTarget.getAttribute('data-id');
                    if (window.removeFromCartAPI) {
                        window.removeFromCartAPI(itemId); // Calls the API function
                    }
                });
            });

            // Quantity input listener
            document.querySelectorAll('.qty-input').forEach(input => {
                // Use 'change' event to send API request only when user finishes input
                input.onchange = (e) => {
                    const itemId = e.target.getAttribute('data-id');
                    let newQty = parseInt(e.target.value);

                    // Ensure quantity is at least 1
                    if (isNaN(newQty) || newQty < 1) {
                        newQty = 1;
                        e.target.value = 1; 
                    }
                    if (window.updateCartItemAPI) {
                        window.updateCartItemAPI(itemId, newQty); // Calls the API function
                    }
                };
            });
        };
        
        // --- Initialization and Global Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            window.fetchCart(); // Initial load of the cart from the API
            window.updateCartCount(); // Update the count in the header
            
            // Checkout button listener
            checkoutBtn.addEventListener('click', () => {
                 if (!checkoutBtn.disabled) {
                     window.location.href = 'checkout.html';
                 } else {
                     window.displayMessage("Your cart is empty. Please add items before checking out.", 'error');
                 }
            });
            
            // Clear Cart button listener
            clearCartBtn.addEventListener('click', () => {
                if (!clearCartBtn.disabled) {
                    // This calls the globally exposed API function
                    window.clearCartAPI(); 
                }
            });
        });
        
    </script>
</body>
</html>
