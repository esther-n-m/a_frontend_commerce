<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Home | Shopping Cart</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use an elegant, sophisticated font like Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-gold: #D4AF37; /* Standard gold color */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d; /* Very dark background */
            color: #f5f5f5; /* Off-white text */
            min-height: 100vh;
        }
        .text-gold {
            color: var(--color-gold);
        }
        .bg-gold {
            background-color: var(--color-gold);
        }
        .border-gold {
            border-color: var(--color-gold);
        }
        .btn-gold {
            background-color: var(--color-gold);
            color: #0d0d0d;
            transition: all 0.3s;
        }
        .btn-gold:hover {
            background-color: #E0C16E;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }
        /* Custom spinner for loading */
        .loader {
            border: 4px solid #333;
            border-top: 4px solid var(--color-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            max-width: 90vw;
        }
        .message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Message Box Container -->
    <div id="message-container" class="message-box"></div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center py-4 border-b border-neutral-700 mb-8">
            <a href="index.html" class="text-3xl font-bold text-gold tracking-widest">SOVEREIGN</a>
            <a href="index.html" class="text-sm font-medium text-gray-400 hover:text-gold transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Continue Shopping
            </a>
        </header>

        <h1 class="text-4xl font-light mb-10 border-b border-neutral-800 pb-4">Your Shopping Cart</h1>

        <div class="grid lg:grid-cols-3 gap-10">
            <!-- Cart Items List (Left/Main Column) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Loading State -->
                <div id="cart-loading" class="flex flex-col items-center justify-center p-20 hidden">
                    <div class="loader"></div>
                    <p class="mt-4 text-lg text-gray-400">Loading your luxury items...</p>
                </div>

                <!-- Empty Cart State -->
                <div id="cart-empty" class="text-center p-16 border border-dashed border-neutral-700 rounded-xl hidden">
                    <p class="text-xl text-gray-500 font-light">Your cart is currently empty.</p>
                    <a href="index.html" class="mt-6 inline-block text-gold hover:text-white transition font-medium">Start Exploring</a>
                </div>

                <!-- Cart Items Container -->
                <div id="cart-items-container" class="space-y-6">
                    <!-- Cart items will be rendered here -->
                </div>
            </div>

            <!-- Cart Summary (Right Column) -->
            <div class="lg:col-span-1">
                <div class="bg-neutral-900 p-6 rounded-xl shadow-2xl space-y-6 sticky top-8 border border-neutral-800">
                    <h2 class="text-2xl font-semibold border-b border-neutral-700 pb-3">Order Summary</h2>

                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span>Subtotal (<span id="cart-item-count">0</span> items)</span>
                            <span id="cart-subtotal" class="font-medium">$0.00</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Shipping</span>
                            <span id="cart-shipping">$15.00</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Taxes (10%)</span>
                            <span id="cart-taxes">$0.00</span>
                        </div>
                    </div>

                    <div class="flex justify-between pt-4 border-t border-neutral-700 text-xl font-bold">
                        <span>Order Total</span>
                        <span id="cart-total" class="text-gold">$0.00</span>
                    </div>

                    <button id="checkout-btn" class="w-full btn-gold py-3 rounded-lg font-semibold text-lg shadow-lg" disabled>
                        Proceed to Checkout
                    </button>
                    <button id="clear-cart-btn" class="w-full text-sm text-gray-500 hover:text-red-500 transition duration-200 py-2" disabled>
                        Clear Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = ''; // Same domain

        // --- DOM Elements ---
        const cartLoading = document.getElementById('cart-loading');
        const cartEmpty = document.getElementById('cart-empty');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartSubtotalEl = document.getElementById('cart-subtotal');
        const cartTaxesEl = document.getElementById('cart-taxes');
        const cartTotalEl = document.getElementById('cart-total');
        const cartItemCountEl = document.getElementById('cart-item-count');
        const checkoutBtn = document.getElementById('checkout-btn');
        const clearCartBtn = document.getElementById('clear-cart-btn');

        // --- Utility Functions ---

        const getToken = () => localStorage.getItem('userToken');

        /**
         * Displays a temporary message overlay.
         * @param {string} message 
         * @param {string} type - 'success' or 'error'
         */
        const displayMessage = (message, type = 'info') => {
            const container = document.getElementById('message-container');
            if (!container) return;

            let classes = "message-box show p-4 rounded-lg shadow-xl text-white font-medium ";
            switch (type) {
                case 'success': classes += 'bg-green-600'; break;
                case 'error': classes += 'bg-red-600'; break;
                case 'info': default: classes += 'bg-blue-600'; break;
            }

            container.className = classes;
            container.textContent = message;

            setTimeout(() => {
                container.classList.remove('show');
            }, 5000);
        };
        window.displayMessage = displayMessage;


        // --- Cart API Functions ---

        /**
         * Core function to fetch the cart data from the backend.
         */
        const fetchCart = async (showLoading = true) => {
            const token = getToken();
            if (!token) {
                window.location.href = 'auth.html';
                return;
            }
            
            if (showLoading) {
                cartLoading.classList.remove('hidden');
                cartItemsContainer.innerHTML = '';
            }
            
            try {
                const response = await fetch(`${BASE_URL}/api/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                     displayMessage('Session expired. Please sign in again.', 'error');
                     localStorage.removeItem('userToken');
                     window.location.href = 'auth.html';
                     return null;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                renderCart(data.items);
                return data.items;

            } catch (error) {
                console.error('Error fetching cart:', error);
                displayMessage('Failed to load cart. Please try refreshing.', 'error');
                return null;
            } finally {
                cartLoading.classList.add('hidden');
            }
        };

        /**
         * API call to update the quantity of a specific cart item.
         * @param {string} itemId - The MongoDB _id of the item in the cart.
         * @param {number} newQuantity 
         */
        const updateCartItemAPI = async (itemId, newQuantity) => {
            const token = getToken();
            if (!token) {
                window.location.href = 'auth.html';
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/cart/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ itemId, quantity: newQuantity }),
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage(`Quantity updated to ${newQuantity}.`, 'success');
                    // Re-fetch and re-render the entire cart to reflect the change and new totals
                    await fetchCart(false); 
                } else {
                    displayMessage(`Update failed: ${data.message || 'Error communicating with server.'}`, 'error');
                }

            } catch (error) {
                console.error('Error updating cart item:', error);
                displayMessage('Network error. Failed to update item.', 'error');
            }
        };

        /**
         * API call to remove a specific cart item.
         * @param {string} itemId - The MongoDB _id of the item in the cart.
         */
        const removeCartItemAPI = async (itemId) => {
            const token = getToken();
            if (!token) {
                window.location.href = 'auth.html';
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/cart/remove/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage('Item removed from cart.', 'success');
                    // Re-fetch and re-render the entire cart
                    await fetchCart(false);
                } else {
                    displayMessage(`Removal failed: ${data.message || 'Error communicating with server.'}`, 'error');
                }

            } catch (error) {
                console.error('Error removing cart item:', error);
                displayMessage('Network error. Failed to remove item.', 'error');
            }
        };

        /**
         * API call to clear the entire cart. Exposed globally for use in checkout.html.
         */
        window.clearCartAPI = async () => {
            const token = getToken();
            if (!token) {
                // If no token, we can't clear the cart.
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/cart/clear`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    displayMessage('Your cart has been cleared.', 'info');
                    // Re-fetch and re-render the entire cart to show empty state
                    await fetchCart(false); 
                    return true;
                } else {
                    const data = await response.json();
                    displayMessage(`Failed to clear cart: ${data.message || 'Error communicating with server.'}`, 'error');
                    return false;
                }

            } catch (error) {
                console.error('Error clearing cart:', error);
                displayMessage('Network error. Failed to clear cart.', 'error');
                return false;
            }
        };


        // --- UI Rendering and Event Handlers ---

        /**
         * Renders a single cart item row HTML.
         * @param {object} item - Cart item object from the API.
         * @returns {string} HTML string.
         */
        const createCartItemHTML = (item) => {
            const itemPrice = item.price * item.quantity;
            const optionsDisplay = (item.size || item.scent) 
                ? `<p class="text-xs text-gray-500 mt-1">${item.size ? 'Size: ' + item.size : ''}${item.scent ? (item.size ? ' | ' : '') + 'Scent: ' + item.scent : ''}</p>`
                : '';

            // CRITICAL: We use item._id for all delete/update operations
            return `
                <div class="flex items-start justify-between border-b border-neutral-800 pb-6 pt-4 space-x-4">
                    <!-- Product Image -->
                    <div class="flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden border border-neutral-800">
                        <img src="${item.image}" onerror="this.onerror=null;this.src='https://placehold.co/96x96/1f2937/d4af37?text=NO+IMG'" 
                             alt="${item.name}" class="w-full h-full object-cover">
                    </div>

                    <!-- Product Details -->
                    <div class="flex-grow min-w-0">
                        <h3 class="text-lg font-medium text-white">${item.name}</h3>
                        ${optionsDisplay}
                        <p class="mt-1 text-gold font-semibold">$${item.price.toFixed(2)} / unit</p>
                    </div>

                    <!-- Quantity Controls -->
                    <div class="flex items-center space-x-2 flex-shrink-0">
                        <div class="flex items-center border border-neutral-700 rounded-lg overflow-hidden">
                            <button class="qty-btn p-2 text-gray-400 hover:bg-neutral-800" data-action="decrement" data-id="${item._id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                            </button>
                            <input type="number" value="${item.quantity}" min="1" 
                                   class="qty-input w-12 text-center bg-neutral-900 border-none focus:ring-0" 
                                   data-id="${item._id}">
                            <button class="qty-btn p-2 text-gray-400 hover:bg-neutral-800" data-action="increment" data-id="${item._id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Total Price and Remove Button -->
                    <div class="flex flex-col items-end flex-shrink-0 min-w-[100px]">
                        <p class="text-lg font-semibold">$${itemPrice.toFixed(2)}</p>
                        <button class="remove-btn text-xs mt-1 text-red-500 hover:text-red-400 transition" data-id="${item._id}">
                            Remove
                        </button>
                    </div>
                </div>
            `;
        };
        
        /**
         * Renders the entire cart and summary section.
         * @param {Array} items 
         */
        const renderCart = (items) => {
            // Store the fetched items globally for easy access in handlers
            window.currentCartItems = items; 
            
            // 1. Render Items
            if (items.length === 0) {
                cartEmpty.classList.remove('hidden');
                cartItemsContainer.innerHTML = '';
            } else {
                cartEmpty.classList.add('hidden');
                const itemsHTML = items.map(createCartItemHTML).join('');
                cartItemsContainer.innerHTML = itemsHTML;
            }

            // 2. Calculate Totals
            const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = subtotal > 0 ? 15.00 : 0.00; // Example shipping logic
            const taxes = subtotal * 0.10;
            const total = subtotal + shipping + taxes;

            // 3. Update Summary UI
            cartItemCountEl.textContent = items.length;
            cartSubtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            cartTaxesEl.textContent = `$${taxes.toFixed(2)}`;
            cartTotalEl.textContent = `$${total.toFixed(2)}`;

            // 4. Update Button State
            const hasItems = items.length > 0;
            checkoutBtn.disabled = !hasItems;
            clearCartBtn.disabled = !hasItems;

            // 5. Attach Dynamic Listeners
            attachCartListeners();
        };

        /**
         * Attaches event listeners to all dynamic elements (buttons, inputs).
         */
        const attachCartListeners = () => {
            const container = cartItemsContainer;
            
            // Remove/Clear Cart
            container.querySelectorAll('.remove-btn').forEach(btn => {
                btn.onclick = (e) => removeCartItemAPI(e.target.getAttribute('data-id'));
            });

            // Quantity Buttons (+/-)
            container.querySelectorAll('.qty-btn').forEach(btn => {
                btn.onclick = (e) => {
                    // Find the closest parent with a data-action attribute
                    const action = btn.getAttribute('data-action');
                    const itemId = btn.getAttribute('data-id');
                    
                    // Find the corresponding input field
                    const input = container.querySelector(`input.qty-input[data-id="${itemId}"]`);
                    let currentQty = parseInt(input.value);
                    
                    let newQty = currentQty;
                    if (action === 'increment') {
                        newQty += 1;
                    } else if (action === 'decrement' && currentQty > 1) {
                        newQty -= 1;
                    }
                    
                    if (newQty !== currentQty) {
                        // Optimistically update the input value before API call
                        input.value = newQty; 
                        updateCartItemAPI(itemId, newQty);
                    }
                };
            });

            // Quantity Input (Manual Change)
            container.querySelectorAll('.qty-input').forEach(input => {
                input.onchange = (e) => {
                    const itemId = e.target.getAttribute('data-id');
                    let newQty = parseInt(e.target.value);

                    // Ensure quantity is at least 1
                    if (isNaN(newQty) || newQty < 1) {
                        newQty = 1;
                        e.target.value = 1; 
                    }
                    updateCartItemAPI(itemId, newQty);
                };
            });
        };
        
        // --- Initialization and Global Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            fetchCart(); // Initial load of the cart from the API
            
            // Checkout button listener
            checkoutBtn.addEventListener('click', () => {
                 // Check button disabled state, which is controlled by renderCart
                 if (!checkoutBtn.disabled) {
                     window.location.href = 'checkout.html';
                 } else {
                     displayMessage("Your cart is empty. Please add items before checking out.", 'error');
                 }
            });
            
            // Clear Cart button listener
            clearCartBtn.addEventListener('click', () => {
                if (!clearCartBtn.disabled) {
                    // This calls the globally exposed API function
                    window.clearCartAPI(); 
                }
            });
        });
        
    </script>
</body>
</html>
